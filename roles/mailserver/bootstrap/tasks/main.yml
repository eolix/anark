---
- name: Update apt cache
  apt: update_cache=yes

- name: Upgrade all safe packages
  apt: upgrade=safe

- name: Install basic packages
  apt: pkg={{ item }} state=installed
  with_items:
    - apt-transport-https
    - git
    - htop
    - iftop
    - iotop
    - python3-software-properties
    - python3-pip
    - python3-setuptools
    - screen
    - sudo
    - unattended-upgrades
    - vim
    - nano
    - zip
    - openssl
    - whois
    - lsb-release
    - wget

- name: Change hostname
  hostname:
    name: "mail.{{mail_domain}}"

- name: Add hostname to to /etc/hosts
  lineinfile:
    dest: /etc/hosts
    regexp: '^127\.0\.0\.1[ \t]+localhost'
    line: "127.0.0.1 localhost mail.{{mail_domain}} mail"
    state: present

- name: Add hostname to to /etc/mailname
  lineinfile:
    dest: /etc/mailname
    line: "mail.{{mail_domain}} mail"
    state: present

- name: Create vmail directory
  file:
    path: "{{ mail_storage }}"
    state: directory

- name: Ensure group "vmail" 
  group:
    name: vmail
    gid: 5000
    state: present

- name: Add user "vmail"  
  user:
    name: vmail
    groups: vmail
    shell: /sbin/nologin
    append: yes
    home: "{{ mail_storage }}"
    uid: 5000
    state: present

- name: Set up all vmail directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '770'
    recurse: yes
    owner: vmail
    group: vmail
  loop:
    - "{{ mail_storage }}"
    - "{{ mail_storage }}/mailboxes"
    - "{{ mail_storage }}/sieve"
    - "{{ mail_storage }}/sieve/global"